### The Google File System

#### 4. Master 节点操作

​     Master节点执行所有的名称空间操作。除此，它管理整个系统中的分片复制：决定放置在哪里，新建新的分片，管理复制以及协调大量全系统的活动以保证分片被全量复制，去平衡所有分片服务间的负载，回收所有未使用的空间。现在讨论每个话题。

#### 4.1 名称空间管理和锁

* 许多Master 操作需要很长时间：例如，一个快照操作必须去撤销所有被快照覆盖的分片服务的租约。我们没有想要去延迟其他Master操作当他们在运行时。因此我们允许多操作同时运行通过使用锁名称空间的区域去保证正确的顺序

* 不像其他传统的文件系统，GFS没有那种把所有文件列在一个目录里的单目录数据结构。也不支持同名文件或者目录的别名（Unix 硬链接或者软链接）GFS 逻辑上标识它的名称空间像 一个映射全路径名到原数据的查找表。通过前缀压缩，这个表可以高效的在内存中表示。名称空间树上的每个节点（或者是一个绝对文件名或者目录名）有一个关联的读写锁。

* 每个Master 操作执行前需要一个集合锁。例如：如果它牵扯 /d1/d2/.../dn/leaf,它将获取再目录名/d1,/d1/d2,...,/d1/d2/.../dn,  上的读锁，并且再全路径名/d1/d2/.../dn/leaf 上的读锁或者写锁。leaf 是一个文件还是一个目录决定于操作。

* 我们现在说明锁机制如何防止一个 /home/user/foo 文件被创建当 /home/user 被快照到 /save/user。快照操作需要获得/home,/save上的读锁。以及 /home/user 和/save/user上的写锁。文件创建获取/home, /home/user 上的读锁。以及/home/user/foo 上的写锁这两个操作将会被恰当地顺序化因为他们都在尝试获得/home/users上的冲突锁，文件创建不需要获得父目录上的写锁因为没有目录，或者像inode-like,数据结构来防止修改。名称上的读锁有效的防止了父目录被删除。
* 一个非常好的锁体质属性是它允许同一个目录上的并发的突变。比如在一个目录上多个文件创建可以并发的执行：每一个获取目录名上的读锁以及文件名上的写锁。目录名上的读锁满足防止目录被删除，重命名，或者被快照。写文件名上的写锁序列化尝试创建相同文件名的文件两次。
* 鱼油命名空间有许多节点，读写锁被懒分配并且不再使用时立马删除。同样，锁在全序一致性下获得防止死锁：他们在命名空间和字典上是第一顺序。

#### 4.2 复制集放置

* 一个GFS集群是高效多层次分布，而不是一层。典型的在多个不同集群架构中有上百的分片服务。这些分片服务反过来被上百个来自相同或者不同的架构上的客户端获取。不同架构上的机器间通信或者需要一次或者多次的网络跳转。另外一个架构上的出入带宽或许比架构上所有机器的聚合带宽低。多层次的分布式意味着为了可拓展性，可靠性，可获得性的一个独特跳转。
* 分片复制集的放置策略为了两个目的：最大的数据可靠性和可获得性，最大的带宽利用。为了两者。把复制集分布在不同的机器上是不够的。这只能保证防止硬盘或者机器失败以及最大化利用机器的带宽。我们必须把分片复制集分配在不同的架构上。这保证了一些复制集可以存活或者保持可用性当一个整个架构被破坏或者离线（例如,由于类似网络跳转或者电源电路等共享的资源的失败）。这也意味着事故，特别是读数据流。当一个分片可以利用多个架构的聚合带宽。另一方面写数据流必须流经多个架构。一个我们乐意做的取舍。

#### 4.3 创建，再复制，再平衡

* 分片副本因为三个理由被创建：分片创建，再复制，再平衡
* 当Master创建一个分片，选择哪里去初始化空复制副本。考虑几个因素。1.我们放置副本在低磁盘使用的分片服务上。随着时间它会平衡分片服务间的磁盘使用2.我们想要限制每个分片服务上的最近创建的数量。尽管创建本身和容易。它可靠的预测最近大量写入流量因为分片被创建当有写的需求。并且在我们的追加一次读多次的工作方式，他们显然成为实际上的他们一旦被完全的写后只读一次。3.综上所述，我们想要一份分片的分布复制集在多架构上。
* 只要可获得的分片数量降到用户指定的数目以下，Master 再复制一个分片。这可能因为多个原因发生：一个分片服务变的不可获得，他报告他的分片被破坏，它的磁盘因为错误变得不可用，或者复制目标增加了。每个分片需要被再复制是被优先级排序的基于几个因素。一个就是离复制目标有多远.例如：我们给更高的优先级给丢失了两个副本的分片而不是丢失一个的。另外，我们选择先复制分片的有效文件而不是属于删除文件的分片。最后为了最小化失败对于运行的应用的影响，我们提高任何正在阻塞客户单进程的分片的优先级。
* Master 采用最高的优先级分片并且复制它通过一些分片服务去复制分片数据直接从一个已存在的已校验的副本。新的副本被放置在那些有着相同目标的被创建出来的。平衡磁盘利用，限制耽搁分片服务上的有效的复制操作，传递架构上的副本。为了避免复制流量压倒客户单流量。Master 限制有效的复制操作数量即为了集群也为了分片服务。每个分片服务通过限制它对于原分片的读请求来限制在复制操作上所占用的带宽。
* 最后，Master 周期性的再平衡副本： 他检验现在的副本的分布并且为了搞呢好的磁盘空间和负载平衡移动副本。同样通过这个操作，主节点缓慢的填满一个新的分片服务而不是立即交换它和新的分片与之而来的高写流量。心副本的放置条件就像上面所讨论的。另外Master 必须选择移除哪一个副本。正常来说，它选择移除哪些在分片服务上剩余空间低于平均的一次来再平衡磁盘空间使用